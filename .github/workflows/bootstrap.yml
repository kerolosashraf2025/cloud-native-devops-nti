name: Bootstrap EKS Cluster

on:
  workflow_dispatch:

jobs:
  bootstrap:
    name: Bootstrap EKS
    runs-on: self-hosted

    env:
      AWS_REGION: eu-west-1
      CLUSTER_NAME: nti-nonprod-eks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ==========================
      # Install kubectl (if missing)
      # ==========================
      - name: Install kubectl (if missing)
        run: |
          if command -v kubectl >/dev/null 2>&1; then
            echo "kubectl already installed ✅"
            kubectl version --client
          else
            echo "Installing kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
            kubectl version --client
          fi

      # ==========================
      # Install Helm
      # ==========================
      - name: Install Helm (if missing)
        run: |
          if command -v helm >/dev/null 2>&1; then
            echo "Helm already installed ✅"
            helm version
          else
            echo "Installing Helm..."
            curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | sudo bash
            helm version
          fi

      # ==========================
      # Update kubeconfig
      # ==========================
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $CLUSTER_NAME

      - name: Verify cluster access
        run: kubectl get nodes

      # ==========================
      # Create namespaces
      # ==========================
      - name: Create namespaces
        run: kubectl apply -f bootstrap/namespaces.yaml

      # ==========================
      # Install Ingress NGINX
      # ==========================
      - name: Install Ingress NGINX
        run: bash bootstrap/helm/ingress-nginx.sh

      # ==========================
      # Install ArgoCD
      # ==========================
      - name: Install ArgoCD
        run: bash bootstrap/helm/argocd.sh

      # ==========================
      # Wait for ArgoCD to be Ready
      # ==========================
      - name: Wait for ArgoCD server
        run: |
          echo "Waiting for ArgoCD server to be ready..."
          kubectl rollout status deployment/argocd-server -n argocd --timeout=600s

      # ==========================
      # Apply ArgoCD Application (GitOps)
      # ==========================
      - name: Apply Sample App ArgoCD Application
        run: |
          echo "Applying ArgoCD Application..."
          kubectl apply -f gitops/nonprod/argocd/sample-app-application.yaml

      # ==========================
      # Install Datadog
      # ==========================
      - name: Install Datadog
        run: bash bootstrap/helm/datadog/install-datadog.sh
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          CLUSTER_NAME: ${{ env.CLUSTER_NAME }}

      # ==========================
      # Terraform Setup
      # ==========================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init (Read Outputs)
        working-directory: terraform
        run: terraform init

      - name: Export External Secrets Role ARN
        working-directory: terraform
        run: |
          ROLE_ARN=$(terraform output -raw external_secrets_irsa_role_arn)
          echo "EXTERNAL_SECRETS_ROLE_ARN=$ROLE_ARN" >> $GITHUB_ENV
          echo "External Secrets Role ARN: $ROLE_ARN"

      # ==========================
      # Install External Secrets Operator
      # ==========================
      - name: Install External Secrets Operator
        run: bash bootstrap/helm/external-secrets/install-external-secrets.sh

      - name: Verify External Secrets Operator
        run: kubectl get pods -n external-secrets

      # ==========================
      # Install SonarQube
      # ==========================
      - name: Install SonarQube
        run: |
          echo "Installing SonarQube..."

          helm repo add sonarqube https://SonarSource.github.io/helm-chart-sonarqube
          helm repo update

          kubectl create namespace sonarqube --dry-run=client -o yaml | kubectl apply -f -

          helm upgrade --install sonarqube sonarqube/sonarqube \
            --namespace sonarqube \
            --set service.type=LoadBalancer \
            --set monitoringPasscode="nti-sonarqube-passcode"

          echo "Waiting for SonarQube to be ready..."
          kubectl rollout status deployment/sonarqube-sonarqube -n sonarqube --timeout=900s || true

      # ==========================
      # OUTPUTS: ArgoCD UI + Sample App URL + SonarQube URL
      # ==========================
      - name: Show ArgoCD UI Access Info
        run: |
          echo "========================================="
          echo "ARGOCD UI ACCESS"
          echo "========================================="

          ARGOCD_LB=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

          if [ -z "$ARGOCD_LB" ]; then
            echo "❌ ArgoCD service does not have a LoadBalancer hostname."
            kubectl get svc -n argocd
          else
            echo "ArgoCD URL: http://$ARGOCD_LB"
            echo "ArgoCD Username: admin"
            echo "ArgoCD Password:"
            kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data.password}" | base64 -d
            echo ""
          fi

      - name: Show Sample App Ingress URL
        run: |
          echo "========================================="
          echo "SAMPLE APP ACCESS"
          echo "========================================="

          APP_LB=$(kubectl get ingress sample-app-ingress -n default -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

          if [ -z "$APP_LB" ]; then
            echo "❌ Sample App ingress does not have a LoadBalancer hostname yet."
            kubectl get ingress -n default
          else
            echo "Sample App URL: http://$APP_LB"
          fi

      - name: Show SonarQube URL
        run: |
          echo "========================================="
          echo "SONARQUBE ACCESS"
          echo "========================================="

          SONAR_LB=$(kubectl get svc sonarqube-sonarqube -n sonarqube -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

          if [ -z "$SONAR_LB" ]; then
            echo "❌ SonarQube LoadBalancer not ready yet."
            kubectl get svc -n sonarqube
          else
            echo "SonarQube URL: http://$SONAR_LB"
          fi

      - name: Show ArgoCD Applications
        run: kubectl get applications -n argocd || true

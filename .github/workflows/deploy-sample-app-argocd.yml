name: Deploy Sample App via ArgoCD

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region eu-west-1 --name nti-nonprod-eks
          kubectl get nodes

      - name: Get latest ECR image tag
        id: ecr
        run: |
          REPO_NAME="cloud-native-sample-app"

          LATEST_TAG=$(aws ecr describe-images \
            --repository-name $REPO_NAME \
            --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
            --output text)

          echo "LATEST_TAG=$LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Update deployment image tag in GitOps manifests
        run: |
          TAG="${{ steps.ecr.outputs.latest_tag }}"
          FILE="gitops/nonprod/sample-app/deployment.yaml"

          sed -i "s|image: .*cloud-native-sample-app:.*|image: 842303506852.dkr.ecr.eu-west-1.amazonaws.com/cloud-native-sample-app:${TAG}|g" $FILE

          echo "Updated deployment.yaml with tag: $TAG"
          cat $FILE

      - name: Commit & Push GitOps changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add gitops/nonprod/sample-app/deployment.yaml
          git commit -m "Update sample-app image tag to ${{ steps.ecr.outputs.latest_tag }}" || echo "No changes to commit"

          git pull --rebase origin main
          git push origin main

      - name: Apply ArgoCD Application
        run: |
          kubectl apply -f gitops/nonprod/argocd/sample-app-application.yaml

      - name: Wait for Deployment to be created
        run: |
          echo "Waiting for deployment sample-app to be created..."
          for i in {1..30}; do
            if kubectl get deployment sample-app -n default >/dev/null 2>&1; then
              echo "Deployment sample-app found ✅"
              kubectl get deployment sample-app -n default
              exit 0
            fi
            echo "Still waiting... ($i/30)"
            sleep 10
          done

          echo "❌ Deployment was not created after waiting."
          kubectl get all -n default
          exit 1

      - name: Wait for pods to be Ready (with debug)
        run: |
          echo "Waiting for deployment rollout..."
          if ! kubectl rollout status deployment/sample-app -n default --timeout=600s; then
            echo "❌ Rollout failed. Printing debug info..."

            echo "====== PODS ======"
            kubectl get pods -n default -o wide

            echo "====== DESCRIBE DEPLOYMENT ======"
            kubectl describe deployment sample-app -n default

            echo "====== DESCRIBE PODS ======"
            kubectl describe pods -n default -l app=sample-app

            echo "====== LOGS ======"
            kubectl logs -n default -l app=sample-app --tail=200

            exit 1
          fi

      - name: Show Ingress URL
        run: |
          echo "====== INGRESS ======"
          kubectl get ingress -n default

          echo "Ingress URL:"
          kubectl get ingress sample-app-ingress -n default -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
          echo ""

name: Trivy Scan (Repo + Docker Images)

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  AWS_ACCOUNT_ID: 842303506852
  ECR_SAMPLE: cloud-native-sample-app
  ECR_WRITER: cloud-native-mongo-writer

jobs:
  trivy-scan:
    runs-on: self-hosted

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # ===============================
      # Get Latest Tag from GitOps
      # ===============================
      - name: Get Latest Image Tag from GitOps
        run: |
          set -e
          echo "Getting latest tag from gitops/nonprod/sample-app/kustomization.yaml ..."

          TAG=$(grep "newTag:" gitops/nonprod/sample-app/kustomization.yaml | head -n 1 | awk '{print $2}')

          if [ -z "$TAG" ]; then
            echo "âŒ ERROR: Could not extract TAG from kustomization.yaml"
            exit 1
          fi

          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Latest TAG found: $TAG"

      # ===============================
      # Install Trivy (Kali Compatible)
      # ===============================
      - name: Install Trivy
        run: |
          set -e
          echo "Installing Trivy..."

          sudo apt-get update -y
          sudo apt-get install -y wget gnupg lsb-release apt-transport-https ca-certificates

          sudo mkdir -p /etc/apt/keyrings

          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key \
            | gpg --dearmor \
            | sudo tee /etc/apt/keyrings/trivy.gpg > /dev/null

          echo "deb [signed-by=/etc/apt/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list

          sudo apt-get update -y
          sudo apt-get install -y trivy

          trivy --version

      # ===============================
      # Scan Repo Filesystem
      # ===============================
      - name: Trivy Scan Repo (Filesystem)
        run: |
          trivy fs --scanners vuln,secret,config \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            .

      # ===============================
      # Configure AWS Credentials
      # ===============================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ===============================
      # Login to ECR
      # ===============================
      - name: Login to ECR
        run: |
          aws ecr get-login-password | docker login \
            --username AWS \
            --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # ===============================
      # Scan Sample App Image
      # ===============================
      - name: Trivy Scan Sample App Image
        run: |
          IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_SAMPLE:$TAG"
          echo "Scanning image: $IMAGE"

          trivy image --severity HIGH,CRITICAL \
            --exit-code 0 \
            $IMAGE

      # ===============================
      # Scan Mongo Writer Image
      # ===============================
      - name: Trivy Scan Mongo Writer Image
        run: |
          IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_WRITER:$TAG"
          echo "Scanning image: $IMAGE"

          trivy image --severity HIGH,CRITICAL \
            --exit-code 0 \
            $IMAGE

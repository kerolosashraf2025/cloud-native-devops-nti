name: Trivy Scan (Repo + Docker Images)

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  AWS_ACCOUNT_ID: 842303506852
  ECR_SAMPLE: cloud-native-sample-app
  ECR_WRITER: cloud-native-mongo-writer
  TRIVY_VERSION: "0.56.2"

jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      # ==========================
      # Checkout Repository
      # ==========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================
      # Cache Trivy DB
      # ==========================
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-cache

      # ==========================
      # Install Trivy (Manual Safe)
      # ==========================
      - name: Install Trivy (Binary Safe)
        run: |
          set -e
          echo "Installing Trivy..."

          wget --timeout=30 --tries=3 -O trivy.tar.gz \
            https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz

          tar -xzf trivy.tar.gz
          sudo mv trivy /usr/local/bin/
          trivy --version

      # ==========================
      # Scan Repo Filesystem (FAST)
      # ==========================
      - name: Trivy Scan Repo (Filesystem)
        run: |
          echo "======================================="
          echo "Scanning repository filesystem..."
          echo "======================================="

          trivy fs . \
            --severity HIGH,CRITICAL \
            --scanners vuln \
            --exit-code 0 \
            --format table

      # ==========================
      # Configure AWS Credentials
      # ==========================
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ==========================
      # Login to Amazon ECR
      # ==========================
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login \
            --username AWS \
            --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # ==========================
      # Get Latest Tag from ECR (Sample App)
      # ==========================
      - name: Get Latest Tag from ECR (Sample App)
        run: |
          TAG=$(aws ecr describe-images \
            --repository-name $ECR_SAMPLE \
            --region $AWS_REGION \
            --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
            --output text)

          if [ -z "$TAG" ] || [ "$TAG" = "None" ]; then
            echo "ERROR: No valid tag found for $ECR_SAMPLE"
            exit 1
          fi

          echo "SAMPLE_TAG=$TAG" >> $GITHUB_ENV
          echo "Latest Sample App Tag: $TAG"

      # ==========================
      # Get Latest Tag from ECR (Mongo Writer)
      # ==========================
      - name: Get Latest Tag from ECR (Mongo Writer)
        run: |
          TAG=$(aws ecr describe-images \
            --repository-name $ECR_WRITER \
            --region $AWS_REGION \
            --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
            --output text)

          if [ -z "$TAG" ] || [ "$TAG" = "None" ]; then
            echo "ERROR: No valid tag found for $ECR_WRITER"
            exit 1
          fi

          echo "WRITER_TAG=$TAG" >> $GITHUB_ENV
          echo "Latest Mongo Writer Tag: $TAG"

      # ==========================
      # Scan Sample App Image
      # ==========================
      - name: Trivy Scan Sample App Image (Latest)
        timeout-minutes: 10
        run: |
          IMAGE=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_SAMPLE:$SAMPLE_TAG
          echo "Scanning image: $IMAGE"

          docker pull $IMAGE

          trivy image $IMAGE \
            --severity HIGH,CRITICAL \
            --scanners vuln \
            --exit-code 0 \
            --format table

      # ==========================
      # Scan Mongo Writer Image
      # ==========================
      - name: Trivy Scan Mongo Writer Image (Latest)
        timeout-minutes: 10
        run: |
          IMAGE=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_WRITER:$WRITER_TAG
          echo "Scanning image: $IMAGE"

          docker pull $IMAGE

          trivy image $IMAGE \
            --severity HIGH,CRITICAL \
            --scanners vuln \
            --exit-code 0 \
            --format table

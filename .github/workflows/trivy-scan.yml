name: Trivy Scan (Repo + Docker Images)

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  AWS_ACCOUNT_ID: 842303506852
  ECR_SAMPLE: cloud-native-sample-app
  ECR_WRITER: cloud-native-mongo-writer

jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================
      # Install Trivy (Binary Safe for Kali)
      # ==========================
      - name: Install Trivy (Binary - Kali Safe)
        run: |
          set -e
          echo "Installing Trivy from official GitHub release..."

          TRIVY_VERSION="0.56.2"

          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz

          tar -xzf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz

          sudo mv trivy /usr/local/bin/

          trivy --version

      # ==========================
      # Scan Repo Filesystem
      # ==========================
      - name: Trivy Scan Repo (Filesystem)
        run: |
          echo "======================================="
          echo "Scanning repository filesystem..."
          echo "======================================="
          trivy fs . --severity HIGH,CRITICAL --exit-code 0

      # ==========================
      # Configure AWS Credentials
      # ==========================
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ==========================
      # Login to ECR
      # ==========================
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password | docker login \
            --username AWS \
            --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # ==========================
      # Get Latest Tag from GitOps kustomization.yaml
      # ==========================
      - name: Get Latest Tag from GitOps
        run: |
          TAG=$(grep "newTag:" gitops/nonprod/sample-app/kustomization.yaml | head -n 1 | awk '{print $2}')
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Using TAG: $TAG"

      # ==========================
      # Scan Sample App Image
      # ==========================
      - name: Trivy Scan Sample App Image
        run: |
          echo "======================================="
          echo "Scanning Sample App Image..."
          echo "======================================="

          IMAGE=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_SAMPLE:$TAG

          docker pull $IMAGE
          trivy image $IMAGE --severity HIGH,CRITICAL --exit-code 0

      # ==========================
      # Scan Mongo Writer Image
      # ==========================
      - name: Trivy Scan Mongo Writer Image
        run: |
          echo "======================================="
          echo "Scanning Mongo Writer Image..."
          echo "======================================="

          IMAGE=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_WRITER:$TAG

          docker pull $IMAGE
          trivy image $IMAGE --severity HIGH,CRITICAL --exit-code 0

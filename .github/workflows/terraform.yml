name: Terraform Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose Terraform action"
        required: true
        default: apply
        type: choice
        options:
          - apply
          - destroy

jobs:
  terraform:
    name: Terraform Infrastructure
    runs-on: self-hosted

    defaults:
      run:
        shell: bash
        working-directory: terraform

    env:
      AWS_REGION: eu-west-1
      CLUSTER_NAME: nti-nonprod-eks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      # ======================================================
      # APPLY
      # ======================================================
      - name: Terraform Plan
        if: ${{ github.event.inputs.action == 'apply' }}
        run: terraform plan -lock-timeout=10m -var-file=nonprod.tfvars

      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        run: terraform apply -lock-timeout=10m -auto-approve -var-file=nonprod.tfvars

      # ======================================================
      # DESTROY (SAFE ORDER)
      # ======================================================

      - name: Cleanup Kubernetes Resources (Services/Ingress) Before Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "=========================================="
          echo "Cleaning Kubernetes resources..."
          echo "=========================================="

          set +e

          aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME

          kubectl delete ingress --all -A --ignore-not-found=true
          kubectl delete svc --all -A --ignore-not-found=true
          kubectl delete deployment --all -A --ignore-not-found=true

          echo "Waiting 90s for AWS to cleanup LBs/ENIs..."
          sleep 90

          echo "Kubernetes cleanup finished ✅"

      - name: Force Delete AWS LoadBalancers (ONLY EKS Cluster Tagged) + TargetGroups
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "=========================================="
          echo "Deleting EKS-related LoadBalancers ONLY..."
          echo "Region: $AWS_REGION"
          echo "Cluster: $CLUSTER_NAME"
          echo "=========================================="

          set +e

          # ============================
          # Delete ALB/NLB (ELBv2)
          # ============================
          LBS=$(aws elbv2 describe-load-balancers \
            --region $AWS_REGION \
            --query "LoadBalancers[].LoadBalancerArn" \
            --output text 2>/dev/null)

          if [ -z "$LBS" ]; then
            echo "No ALB/NLB found in region ✅"
          else
            for lb in $LBS; do
              TAG=$(aws elbv2 describe-tags \
                --region $AWS_REGION \
                --resource-arns "$lb" \
                --query "TagDescriptions[].Tags[?Key=='kubernetes.io/cluster/$CLUSTER_NAME'].Value" \
                --output text 2>/dev/null)

              if [ "$TAG" = "owned" ] || [ "$TAG" = "shared" ]; then
                echo "Deleting LB (EKS tagged): $lb"
                aws elbv2 delete-load-balancer --load-balancer-arn "$lb" --region $AWS_REGION || true
              else
                echo "Skipping LB (not related to cluster): $lb"
              fi
            done
          fi

          # ============================
          # Wait for LB deletion
          # ============================
          echo "=========================================="
          echo "Waiting for LoadBalancers to terminate..."
          echo "=========================================="

          for i in {1..25}; do
            REMAINING=$(aws elbv2 describe-load-balancers \
              --region $AWS_REGION \
              --query "LoadBalancers[].LoadBalancerArn" \
              --output text 2>/dev/null)

            if [ -z "$REMAINING" ]; then
              echo "All LBs deleted ✅"
              break
            fi

            echo "Still waiting... attempt $i/25"
            sleep 15
          done

          # ============================
          # Delete Target Groups
          # ============================
          echo "=========================================="
          echo "Deleting Target Groups related to EKS..."
          echo "=========================================="

          TGS=$(aws elbv2 describe-target-groups \
            --region $AWS_REGION \
            --query "TargetGroups[].TargetGroupArn" \
            --output text 2>/dev/null)

          if [ -z "$TGS" ]; then
            echo "No Target Groups found ✅"
          else
            for tg in $TGS; do
              TG_TAG=$(aws elbv2 describe-tags \
                --region $AWS_REGION \
                --resource-arns "$tg" \
                --query "TagDescriptions[].Tags[?Key=='kubernetes.io/cluster/$CLUSTER_NAME'].Value" \
                --output text 2>/dev/null)

              if [ "$TG_TAG" = "owned" ] || [ "$TG_TAG" = "shared" ]; then
                echo "Deleting TargetGroup (EKS tagged): $tg"
                aws elbv2 delete-target-group --target-group-arn "$tg" --region $AWS_REGION || true
              else
                echo "Skipping TargetGroup (not related to cluster): $tg"
              fi
            done
          fi

          echo "LB + TargetGroups cleanup finished ✅"

      - name: Terraform Destroy EKS NodeGroups First
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "=========================================="
          echo "Destroying EKS NodeGroups first..."
          echo "=========================================="

          set +e

          terraform destroy -lock-timeout=20m -auto-approve -var-file=nonprod.tfvars -target=module.eks.module.eks_managed_node_group || true
          terraform destroy -lock-timeout=20m -auto-approve -var-file=nonprod.tfvars -target=module.eks.module.eks_managed_node_groups || true

          echo "NodeGroups destroy attempted ✅"

      - name: Terraform Destroy EKS Cluster
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "=========================================="
          echo "Destroying EKS Cluster..."
          echo "=========================================="

          set -e
          terraform destroy -lock-timeout=20m -auto-approve -var-file=nonprod.tfvars -target=module.eks

          echo "EKS Cluster destroyed ✅"

      - name: Terraform Destroy IAM
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "=========================================="
          echo "Destroying IAM..."
          echo "=========================================="

          set -e
          terraform destroy -lock-timeout=20m -auto-approve -var-file=nonprod.tfvars -target=module.iam

          echo "IAM destroyed ✅"

      - name: Terraform Destroy Networking (VPC LAST)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "=========================================="
          echo "Destroying Networking (VPC)..."
          echo "=========================================="

          set -e
          terraform destroy -lock-timeout=20m -auto-approve -var-file=nonprod.tfvars -target=module.networking

          echo "Networking destroyed ✅"

      - name: Remove ECR from Terraform State (Keep ECR in AWS)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "=========================================="
          echo "Removing ECR from Terraform state (keeping ECR in AWS)..."
          echo "=========================================="

          set +e

          terraform state list | grep aws_ecr_repository || true

          terraform state rm aws_ecr_repository.sample_app || true
          terraform state rm aws_ecr_repository.mongo_writer || true

          echo "ECR removed from Terraform state ✅"

      - name: Terraform Destroy Remaining Resources
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          echo "=========================================="
          echo "Destroying remaining resources..."
          echo "=========================================="

          set -e
          terraform destroy -lock-timeout=20m -auto-approve -var-file=nonprod.tfvars

          echo "Final Destroy finished ✅"

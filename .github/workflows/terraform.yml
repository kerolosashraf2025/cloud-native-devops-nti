name: Terraform Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose Terraform action"
        required: true
        default: apply
        type: choice
        options:
          - apply
          - destroy

jobs:
  terraform:
    name: Terraform Infrastructure
    runs-on: self-hosted

    defaults:
      run:
        shell: bash
        working-directory: terraform

    env:
      AWS_REGION: eu-west-1
      CLUSTER_NAME: nti-nonprod-eks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      # ======================================================
      # APPLY
      # ======================================================
      - name: Terraform Plan
        if: ${{ github.event.inputs.action == 'apply' }}
        run: terraform plan -lock-timeout=5m -var-file=nonprod.tfvars

      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        run: terraform apply -lock-timeout=5m -auto-approve -var-file=nonprod.tfvars

      # ======================================================
      # DESTROY (FAST ORDER)
      # ======================================================

      - name: Remove ECR from Terraform State (Keep ECR in AWS)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          set +e
          echo "=========================================="
          echo "Removing ECR repos from Terraform state..."
          echo "=========================================="

          terraform state list | grep aws_ecr_repository && echo "ECR resources found in state" || echo "No ECR resources found"

          terraform state rm aws_ecr_repository.sample_app || true
          terraform state rm aws_ecr_repository.mongo_writer || true

          echo "ECR removed from state ✅ (repos still exist in AWS)"

      - name: Force Delete AWS LoadBalancers + TargetGroups (FAST)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          set +e

          echo "=========================================="
          echo "Deleting ALL Classic ELBs..."
          echo "=========================================="
          ELBS=$(aws elb describe-load-balancers --region $AWS_REGION --query 'LoadBalancerDescriptions[].LoadBalancerName' --output text 2>/dev/null)

          if [ -n "$ELBS" ]; then
            for elb in $ELBS; do
              echo "Deleting Classic ELB: $elb"
              aws elb delete-load-balancer --load-balancer-name "$elb" --region $AWS_REGION || true
            done
          else
            echo "No Classic ELBs found ✅"
          fi

          echo "=========================================="
          echo "Deleting ALL ALB/NLB..."
          echo "=========================================="
          LBS=$(aws elbv2 describe-load-balancers --region $AWS_REGION --query 'LoadBalancers[].LoadBalancerArn' --output text 2>/dev/null)

          if [ -n "$LBS" ]; then
            for lb in $LBS; do
              echo "Deleting LB ARN: $lb"
              aws elbv2 delete-load-balancer --load-balancer-arn "$lb" --region $AWS_REGION || true
            done
          else
            echo "No ALB/NLB found ✅"
          fi

          echo "=========================================="
          echo "Waiting 30s for LB cleanup..."
          echo "=========================================="
          sleep 30

          echo "=========================================="
          echo "Deleting ALL Target Groups..."
          echo "=========================================="
          TGS=$(aws elbv2 describe-target-groups --region $AWS_REGION --query 'TargetGroups[].TargetGroupArn' --output text 2>/dev/null)

          if [ -n "$TGS" ]; then
            for tg in $TGS; do
              echo "Deleting TargetGroup: $tg"
              aws elbv2 delete-target-group --target-group-arn "$tg" --region $AWS_REGION || true
            done
          else
            echo "No Target Groups found ✅"
          fi

          echo "LB + TargetGroups cleanup finished ✅"

      - name: Terraform Destroy EKS (will delete EC2 Nodes)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          set +e
          echo "=========================================="
          echo "Destroying EKS first..."
          echo "=========================================="
          terraform destroy -lock-timeout=15m -auto-approve -var-file=nonprod.tfvars -target=module.eks
          echo "EKS Destroy finished ✅"

      - name: Terraform Destroy IAM
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          set +e
          echo "=========================================="
          echo "Destroying IAM..."
          echo "=========================================="
          terraform destroy -lock-timeout=15m -auto-approve -var-file=nonprod.tfvars -target=module.iam
          echo "IAM Destroy finished ✅"

      - name: Terraform Destroy Networking (VPC)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          set +e
          echo "=========================================="
          echo "Destroying Networking (VPC)..."
          echo "=========================================="
          terraform destroy -lock-timeout=15m -auto-approve -var-file=nonprod.tfvars -target=module.networking
          echo "Networking Destroy finished ✅"

      - name: Terraform Destroy Remaining Resources (ignore failures)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: |
          set +e
          echo "=========================================="
          echo "Destroying remaining resources..."
          echo "=========================================="
          terraform destroy -lock-timeout=15m -auto-approve -var-file=nonprod.tfvars || true
          echo "Final Destroy finished ✅"

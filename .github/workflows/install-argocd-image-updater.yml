name: Install ArgoCD Image Updater

on:
  workflow_dispatch:

jobs:
  install-image-updater:
    name: Install ArgoCD Image Updater
    runs-on: self-hosted

    defaults:
      run:
        shell: bash

    steps:
      # 1️⃣ Checkout Repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      # 3️⃣ Install kubectl if not exists
      - name: Install kubectl
        run: |
          if command -v kubectl >/dev/null 2>&1; then
            echo "kubectl already installed ✅"
            kubectl version --client
          else
            echo "Installing kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/kubectl
            kubectl version --client
          fi

      # 4️⃣ Update kubeconfig
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region eu-west-1 --name nti-nonprod-eks
          kubectl get nodes

      # 5️⃣ Install Helm if not exists
      - name: Install Helm
        run: |
          if command -v helm >/dev/null 2>&1; then
            echo "Helm already installed ✅"
            helm version
          else
            echo "Installing Helm..."
            curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
            helm version
          fi

      # 6️⃣ Add Helm Repo
      - name: Add Argo Helm Repo
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update

      # 7️⃣ Install ArgoCD Image Updater
      - name: Install ArgoCD Image Updater
        run: |
          kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

          helm upgrade --install argocd-image-updater argo/argocd-image-updater \
            --namespace argocd \
            --set config.argocd.serverAddress=argocd-server.argocd.svc \
            --set config.logLevel=info

      # 8️⃣ Patch ServiceAccount with IRSA (Optional / If Needed)
      - name: Check Image Updater Pods
        run: |
          kubectl get pods -n argocd
          kubectl get deployment -n argocd | grep image-updater || true

      # 9️⃣ Show Logs
      - name: Show Image Updater Logs
        continue-on-error: true
        run: |
          POD=$(kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-image-updater -o jsonpath="{.items[0].metadata.name}")
          echo "Pod Name: $POD"
          kubectl logs -n argocd $POD --tail=100

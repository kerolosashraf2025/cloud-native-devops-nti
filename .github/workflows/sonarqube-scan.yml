name: SonarQube Code Scan

on:
  workflow_dispatch:

jobs:
  sonarqube-scan:
    runs-on: self-hosted

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================
      # SonarQube Scan using Docker Scanner
      # ==========================
      - name: Run SonarQube Scan
        run: |
          echo "=========================================="
          echo "Running SonarQube Scan..."
          echo "=========================================="

          docker run --rm \
            -e SONAR_HOST_URL="${SONAR_HOST_URL}" \
            -e SONAR_TOKEN="${SONAR_TOKEN}" \
            -v "$(pwd):/usr/src" \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.projectKey=cloud-native-devops-nti \
            -Dsonar.projectName="cloud-native-devops-nti" \
            -Dsonar.sources=. \
            -Dsonar.exclusions="**/terraform/**,**/gitops/**,**/.github/**,**/bootstrap/**,**/venv/**,**/__pycache__/**" \
            -Dsonar.python.version=3.11

      - name: Done
        run: echo "âœ… SonarQube Scan Completed Successfully"

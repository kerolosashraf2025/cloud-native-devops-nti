name: CI - Build & Push + Update GitOps

on:
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: self-hosted

    env:
      AWS_REGION: eu-west-1
      AWS_ACCOUNT_ID: 842303506852

      ECR_REPO_APP: cloud-native-sample-app
      ECR_REPO_WRITER: cloud-native-mongo-writer

      IMAGE_TAG: latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # ==========================================================
      # Build & Push Sample App
      # ==========================================================
      - name: Build & Push Sample App Image
        run: |
          APP_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_APP:$IMAGE_TAG"

          echo "Building Sample App Image: $APP_IMAGE"
          docker build -t $APP_IMAGE ./app

          echo "Pushing Sample App Image..."
          docker push $APP_IMAGE

      # ==========================================================
      # Build & Push Mongo Writer
      # ==========================================================
      - name: Build & Push Mongo Writer Image
        run: |
          WRITER_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_WRITER:$IMAGE_TAG"

          echo "Building Mongo Writer Image: $WRITER_IMAGE"
          docker build -t $WRITER_IMAGE ./mongo-writer

          echo "Pushing Mongo Writer Image..."
          docker push $WRITER_IMAGE

      # ==========================================================
      # Update GitOps Manifests (Kustomize)
      # ==========================================================
      - name: Update GitOps manifests automatically
        run: |
          echo "Updating kustomization.yaml images..."

          cd gitops/nonprod/sample-app

          cat kustomization.yaml

          echo "------------------------------------------"

          # Update Sample App image
          yq -i '.images[] |= (select(.name=="sample-app").newName = "'"$AWS_ACCOUNT_ID"'.dkr.ecr.'"$AWS_REGION"'.amazonaws.com/'"$ECR_REPO_APP"'")' kustomization.yaml
          yq -i '.images[] |= (select(.name=="sample-app").newTag = "'"$IMAGE_TAG"'")' kustomization.yaml

          # Update Mongo Writer image
          yq -i '.images[] |= (select(.name=="mongo-writer").newName = "'"$AWS_ACCOUNT_ID"'.dkr.ecr.'"$AWS_REGION"'.amazonaws.com/'"$ECR_REPO_WRITER"'")' kustomization.yaml
          yq -i '.images[] |= (select(.name=="mongo-writer").newTag = "'"$IMAGE_TAG"'")' kustomization.yaml

          echo "Updated file:"
          cat kustomization.yaml

      # ==========================================================
      # Commit & Push
      # ==========================================================
      - name: Commit & Push GitOps updates
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"

          git add gitops/nonprod/sample-app/kustomization.yaml

          git commit -m "Auto update images tags to latest" || echo "No changes to commit"

          git pull origin main --rebase || true

          git push origin main

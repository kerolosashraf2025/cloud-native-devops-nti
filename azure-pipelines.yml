trigger:
- main

variables:
  TF_VERSION: "1.6.6"
  TF_ROOT: "terraform"
  TF_VARS_FILE: "nonprod.tfvars"
  AWS_DEFAULT_REGION: "us-east-1"

stages:
- stage: Terraform_Apply
  displayName: "Terraform Apply - NonProd"
  jobs:
  - job: Apply
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - script: |
        sudo apt-get update
        sudo apt-get install -y unzip wget
        wget https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
        unzip terraform_${TF_VERSION}_linux_amd64.zip
        sudo mv terraform /usr/local/bin/
        terraform --version
      displayName: "Install Terraform"

    - script: terraform init
      workingDirectory: $(TF_ROOT)
      displayName: "Terraform Init"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

    - script: terraform plan -var-file=$(TF_VARS_FILE)
      workingDirectory: $(TF_ROOT)
      displayName: "Terraform Plan"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

    - script: terraform apply -auto-approve -var-file=$(TF_VARS_FILE)
      workingDirectory: $(TF_ROOT)
      displayName: "Terraform Apply"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)
